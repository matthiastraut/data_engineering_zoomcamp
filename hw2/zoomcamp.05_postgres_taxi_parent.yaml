id: 05_postgres_taxi_parent
namespace: zoomcamp

inputs:
  - id: all_months # Full list of months
    type: ARRAY
    itemType: STRING
    defaults:
      - "01"
      - "02"
      - "03"
      - "04"
      - "05"
      - "06"
      - "07"
      - "08"
      - "09"
      - "10"
      - "11"
      - "12"

  - id: restricted_months_for_last_year # Restricted list for the last year (e.g., only Q1)
    type: ARRAY
    itemType: STRING
    defaults:
      - "01"
      - "02"
      - "03"
      - "04"
      - "05"
      - "06"
      - "07"

  - id: years_to_process # Years to iterate, ensuring the last year is identifiable
    type: ARRAY
    itemType: STRING
    defaults:
      - "2019"
      - "2020"
      - "2021" # This will be treated as the 'last year' in this example

tasks:
  - id: taxi_type
    type: io.kestra.plugin.core.flow.ForEach
    values: [ "green", "yellow" ]
    tasks:
    - id: year_loop
      type: io.kestra.plugin.core.flow.ForEach
      values: "{{ inputs.years_to_process }}"
      tasks:
      - id: month_loop
        type: io.kestra.plugin.core.flow.ForEach
        values: "{{ parents[0].taskrun.value == inputs.years_to_process | last ? inputs.restricted_months_for_last_year : inputs.all_months }}"
        tasks:
          - id: call_subflow_instance
            type: io.kestra.plugin.core.flow.Subflow
            namespace: zoomcamp
            flowId: 04_postgres_taxi
            wait: true
            inputs:
              taxi: "{{ parents[1].taskrun.value }}" # Correctly references the 'taxi_type' loop
              year: "{{ parents[0].taskrun.value }}" # Correctly references the 'year_loop'
              month: "{{ taskrun.value }}"           # Correctly references the 'month_loop'